<!DOCTYPE html>
<html>
	<head>
		<title>Crazy Canvas</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<style>
			canvas {
				border: 1px solid black
			}
		</style>

		<script src="loadImages.js"></script>
		<script src="dancers.js"></script>
		<script src="figures.js"></script>

		<script>
			// floor size
			var floorWidth;
			var floorHeight;
			var xPixels;
			var yPixels;

			var barTime = 2000;
			//one bar takes 5 seconds
			var bar = 1;
			var time = 0;
			var interval = 100;
			var steps = barTime / interval;
			
			var figureOf8 = new figureOfEight();

			function init() {

				danceFloor = document.getElementById('danceFloor');
				floorWidth = danceFloor.width;
				floorHeight = danceFloor.height;

				context = danceFloor.getContext('2d');
				drawSet();
				heartBeat();
			}

			function drawSet() {
				xPixels = Math.floor(floorWidth / grid.x);
				yPixels = Math.floor(floorHeight / grid.y);
				for (var i = 0; i < dancers.length; i++) {
					dancers[i].pixelPosition.x = dancers[i].startingPosition.x * xPixels - 32;
					dancers[i].pixelPosition.y = dancers[i].startingPosition.y * yPixels - 32;
					context.drawImage(dancers[i].image, dancers[i].pixelPosition.x, dancers[i].pixelPosition.y);
				}

			}

			function heartBeat() {
				time = time + interval;
				if ((time % barTime) === 0) {
					bar = bar + 1;
				}
				draw();
				setTimeout(function() {
					heartBeat();
				}, interval);
			}

			function draw() {

				// music and timing
				var barEndsTime = bar * barTime;
				var timeLeft = barEndsTime - time;
				var numberOfMoves = timeLeft / interval;

				// redraw each of the dancers
				xPixels = Math.floor(floorWidth / grid.x);
				yPixels = Math.floor(floorHeight / grid.y);
				for (var i = 0; i < dancers.length; i++) {

					// clear the original
					context.fillStyle = "white";
					context.fillRect(dancers[i].pixelPosition.x, dancers[i].pixelPosition.y, 64, 64);
					
					var offset = {
						x: dancers[i].startingPosition.x * xPixels - 32 ,
						y: dancers[i].startingPosition.y * yPixels - 32
					};

					// relative (to the starting position) new position
					var destX = figureOf8.whereShouldIBe(dancers[i].role, bar % 8).x;
					var destY = figureOf8.whereShouldIBe(dancers[i].role, bar % 8).y;

					var distanceLeft = {
						vectX : (destX * xPixels) + offset.x - dancers[i].pixelPosition.x,
						vectY : (destY * yPixels) + offset.y - dancers[i].pixelPosition.y
					};
					
					dancers[i].pixelPosition.x = dancers[i].pixelPosition.x + (distanceLeft.vectX / numberOfMoves);
					dancers[i].pixelPosition.y = dancers[i].pixelPosition.y + (distanceLeft.vectY / numberOfMoves);
					context.drawImage(dancers[i].image, dancers[i].pixelPosition.x, dancers[i].pixelPosition.y);
				}

				document.getElementById("bar").innerHTML = "Bar: " + bar + " Time: " + time / 1000 + " seconds";
			}

		</script>
	</head>

	<body onLoad="init();">
		<div>
			<canvas id="danceFloor" width="400" height="600"></canvas>
		</div>
		<div  id="bar"></div>
	</body>
</html>